<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e40af">
  <meta name="description" content="ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ä½œã™ã‚‹å°èª¬åŸ·ç­†ãƒ„ãƒ¼ãƒ«ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ãˆã¾ã™ã€‚">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
  <title>Novel Writer - ãƒ­ãƒ¼ã‚«ãƒ«å°èª¬åŸ·ç­†ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .drag-over {
      border: 2px dashed #3b82f6 !important;
      background-color: #eff6ff !important;
    }
    .card-column {
      min-height: 400px;
    }
    
    /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
    /* ã‚´ã‚·ãƒƒã‚¯ç³» */
    .font-gothic {
      font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", "Yu Gothic", YuGothic, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ Pro", "Hiragino Kaku Gothic Pro", "MS Pã‚´ã‚·ãƒƒã‚¯", sans-serif;
    }
    .font-meiryo {
      font-family: "ãƒ¡ã‚¤ãƒªã‚ª", Meiryo, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", sans-serif;
    }
    .font-noto-sans {
      font-family: "Noto Sans JP", sans-serif;
    }
    
    /* æ˜æœç³» */
    .font-mincho {
      font-family: "æ¸¸æ˜æœ", "Yu Mincho", YuMincho, "Hiragino Mincho ProN", "Hiragino Mincho Pro", "HGæ˜æœE", "MS Pæ˜æœ", "MS æ˜æœ", serif;
    }
    .font-noto-serif {
      font-family: "Noto Serif JP", serif;
    }
    
    /* å¤‰ã‚ã‚Šç¨® */
    .font-maru {
      font-family: "Zen Maru Gothic", "M PLUS Rounded 1c", "Kosugi Maru", sans-serif;
    }
    .font-klee {
      font-family: "Klee One", cursive;
    }
    
    /* æ²¡å…¥å‹ã‚¨ãƒ‡ã‚£ã‚¿ */
    .immersive-editor {
      background: linear-gradient(to bottom, #faf9f7 0%, #f5f3f0 100%);
      height: 100vh;
      overflow: hidden;
    }
    .dark .immersive-editor {
      background: linear-gradient(to bottom, #1a1a1a 0%, #0f0f0f 100%);
    }
    
    .writing-area {
      max-width: 800px;
      margin: 0 auto;
      padding: 60px 60px 40px 60px;
      line-height: 2;
      font-size: 18px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ç›®ã«å„ªã—ã„æ–‡å­—è‰² */
    .text-comfortable-light {
      color: #374151;
    }
    .text-comfortable-dark {
      color: #d1d5db;
    }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ï¼ˆUIã¯é™¤å¤–ï¼‰ */
    .font-content {
      /* JavaScriptã§å‹•çš„ã«é©ç”¨ã•ã‚Œã‚‹ */
    }
    
    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    .dark {
      color-scheme: dark;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const getFontClass = (fontFamily) => {
      const fontMap = {
        'gothic': 'font-gothic',
        'meiryo': 'font-meiryo',
        'noto-sans': 'font-noto-sans',
        'mincho': 'font-mincho',
        'noto-serif': 'font-noto-serif',
        'maru': 'font-maru',
        'klee': 'font-klee'
      };
      return fontMap[fontFamily] || 'font-gothic';
    };

    // åˆæœŸãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    const initialProject = {
      id: Date.now(),
      title: 'æ–°è¦ä½œå“',
      theme: '',
      characters: [],
      plot: {
        èµ·: [],
        æ‰¿: [],
        è»¢: [],
        çµ: []
      },
      worldSettings: [],
      manuscripts: []
    };

    function App() {
      const [projects, setProjects] = useState([]);
      const [currentProject, setCurrentProject] = useState(null);
      const [activeTab, setActiveTab] = useState('ãƒ†ãƒ¼ãƒ');
      const [draggedCard, setDraggedCard] = useState(null);
      const [darkMode, setDarkMode] = useState(false);
      const [fontFamily, setFontFamily] = useState('gothic');
      const [showSettings, setShowSettings] = useState(false);
      const [immersiveMode, setImmersiveMode] = useState(false);
      const [showMobileMenu, setShowMobileMenu] = useState(false);

      // åˆæœŸåŒ–
      useEffect(() => {
        const savedProjects = localStorage.getItem('novelWriterProjects');
        const savedDarkMode = localStorage.getItem('novelWriterDarkMode');
        const savedFont = localStorage.getItem('novelWriterFont');
        
        if (savedDarkMode) setDarkMode(savedDarkMode === 'true');
        if (savedFont) setFontFamily(savedFont);
        
        if (savedProjects) {
          const parsed = JSON.parse(savedProjects);
          setProjects(parsed);
          if (parsed.length > 0) {
            setCurrentProject(parsed[0]);
          }
        } else {
          const newProject = { ...initialProject };
          setProjects([newProject]);
          setCurrentProject(newProject);
        }

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ãŸå ´åˆï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('immersive') === 'true') {
          setActiveTab('ç·¨é›†');
          setImmersiveMode(true);
          
          // chapterIdãŒã‚ã‚Œã°ã€ãã®ãƒapterã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹å‡¦ç†ã¯
          // ManuscriptTabã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§è¡Œã†
        }
      }, []);

      // ä¿å­˜
      useEffect(() => {
        if (projects.length > 0) {
          localStorage.setItem('novelWriterProjects', JSON.stringify(projects));
        }
      }, [projects]);

      // ä»–ã®ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
      useEffect(() => {
        const handleStorageChange = (e) => {
          if (e.key === 'novelWriterProjects' && e.newValue) {
            const parsed = JSON.parse(e.newValue);
            setProjects(parsed);
            
            // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
            if (currentProject) {
              const updated = parsed.find(p => p.id === currentProject.id);
              if (updated) {
                setCurrentProject(updated);
              }
            }
          }
        };

        window.addEventListener('storage', handleStorageChange);
        return () => window.removeEventListener('storage', handleStorageChange);
      }, [currentProject]);

      // è¨­å®šä¿å­˜
      useEffect(() => {
        localStorage.setItem('novelWriterDarkMode', darkMode);
        localStorage.setItem('novelWriterFont', fontFamily);
        
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode, fontFamily]);

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
      const updateCurrentProject = (updates) => {
        const updatedProject = { ...currentProject, ...updates };
        setCurrentProject(updatedProject);
        setProjects(projects.map(p => p.id === updatedProject.id ? updatedProject : p));
      };

      // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
      const createNewProject = () => {
        const newProject = { ...initialProject, id: Date.now() };
        setProjects([...projects, newProject]);
        setCurrentProject(newProject);
      };

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      const exportData = () => {
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const filename = `novel-writer_${year}${month}${day}_${hours}${minutes}.json`;
        
        const dataStr = JSON.stringify(projects, null, 2);
        
        // Androidã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ­£ã—ãä»˜ãã‚ˆã†ã«Data URLã‚’ä½¿ç”¨
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const link = document.createElement('a');
        link.href = dataUri;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const importData = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const imported = JSON.parse(event.target.result);
              setProjects(imported);
              if (imported.length > 0) {
                setCurrentProject(imported[0]);
              }
            } catch (error) {
              alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          };
          reader.readAsText(file);
        }
      };

      if (!currentProject) {
        return <div className="flex items-center justify-center h-screen">èª­ã¿è¾¼ã¿ä¸­...</div>;
      }

      return (
        <div className={`flex h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
          {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */}
          {!immersiveMode && (
            <button
              onClick={() => setShowMobileMenu(true)}
              className={`md:hidden fixed top-4 left-4 z-50 p-2 rounded-lg ${darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-800'} shadow-lg`}
            >
              â˜°
            </button>
          )}

          {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
          {!immersiveMode && showMobileMenu && (
            <>
              <div
                className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40"
                onClick={() => setShowMobileMenu(false)}
              />
              <div className={`md:hidden fixed left-0 top-0 bottom-0 w-64 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-r z-50 flex flex-col overflow-y-auto`}>
                <div className="flex justify-end p-4">
                  <button
                    onClick={() => setShowMobileMenu(false)}
                    className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                  >
                    âœ•
                  </button>
                </div>
                
                {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ï¼‰ */}
                <div className="px-4 pb-4 flex-1">
                  <h1 className={`text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{currentProject?.title || 'Novel Writer'}</h1>
                  <p className={`text-sm mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{currentProject?.theme?.substring(0, 50) || 'æœ€å¼·é­”è¡“å¸«ã¨æ„šéˆã«ãªã‚ŠãŸããªã„é¸æŠ'}{currentProject?.theme?.length > 50 ? '...' : ''}</p>
                  
                  <nav className="space-y-1 mb-6">
                    {['ãƒ†ãƒ¼ãƒ', 'ãƒ—ãƒ­ãƒƒãƒˆ', 'ç·¨é›†', 'ç™»å ´äººç‰©', 'ä¸–ç•Œè¦³'].map((tab) => (
                      <button
                        key={tab}
                        onClick={() => {
                          setActiveTab(tab);
                          setShowMobileMenu(false);
                        }}
                        className={`w-full text-left px-4 py-2 rounded-lg transition ${
                          activeTab === tab
                            ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-50 text-blue-600'
                            : darkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-100'
                        }`}
                      >
                        {tab}
                      </button>
                    ))}
                  </nav>

                  <button
                    onClick={() => {
                      setShowSettings(true);
                      setShowMobileMenu(false);
                    }}
                    className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} rounded-lg transition text-sm mb-4 flex items-center justify-center gap-2`}
                  >
                    âš™ï¸ è¨­å®š
                  </button>

                  <div className="space-y-2">
                    <button
                      onClick={() => {
                        createNewProject();
                        setShowMobileMenu(false);
                      }}
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
                    >
                      æ–°è¦ä½œå“
                    </button>
                    <button
                      onClick={() => {
                        exportData();
                        setShowMobileMenu(false);
                      }}
                      className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg transition text-sm`}
                    >
                      ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <label className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg transition text-sm block text-center cursor-pointer`}>
                      ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                      <input type="file" accept=".json" onChange={(e) => {
                        importData(e);
                        setShowMobileMenu(false);
                      }} className="hidden" />
                    </label>
                  </div>
                </div>
              </div>
            </>
          )}

          {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ - æ²¡å…¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯éè¡¨ç¤ºã€ç‹­ã„ç”»é¢ã§ã¯éš ã™ */}
          {!immersiveMode && (
            <div className={`w-64 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-r flex flex-col hidden md:flex`}>
            <div className={`p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
              <h1 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Novel Writer</h1>
              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-1`}>{currentProject.title}</p>
            </div>

            <nav className="flex-1 p-4">
              <div className="space-y-1">
                {['ãƒ†ãƒ¼ãƒ', 'ãƒ—ãƒ­ãƒƒãƒˆ', 'ç·¨é›†', 'ç™»å ´äººç‰©', 'ä¸–ç•Œè¦³'].map((tab) => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`w-full text-left px-4 py-2 rounded-lg transition ${
                      activeTab === tab
                        ? darkMode 
                          ? 'bg-blue-900 text-blue-200 font-medium'
                          : 'bg-blue-50 text-blue-600 font-medium'
                        : darkMode
                          ? 'text-gray-300 hover:bg-gray-700'
                          : 'text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {tab}
                  </button>
                ))}
              </div>
            </nav>

            <div className={`p-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} space-y-2`}>
              <button
                onClick={() => setShowSettings(!showSettings)}
                className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} rounded-lg transition text-sm ${darkMode ? 'text-white' : 'text-gray-700'}`}
              >
                âš™ï¸ è¨­å®š
              </button>
              <button
                onClick={createNewProject}
                className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
              >
                æ–°è¦ä½œå“
              </button>
              <button
                onClick={exportData}
                className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg transition text-sm`}
              >
                ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
              </button>
              <label className={`w-full px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg transition text-sm block text-center cursor-pointer`}>
                ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                <input type="file" accept=".json" onChange={importData} className="hidden" />
              </label>
            </div>
          </div>
          )}

          {/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowSettings(false)}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-6 max-w-md w-full mx-4`} onClick={(e) => e.stopPropagation()}>
                <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>è¨­å®š</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      ãƒ†ãƒ¼ãƒ
                    </label>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setDarkMode(false)}
                        className={`flex-1 px-4 py-2 rounded-lg ${!darkMode ? 'bg-blue-600 text-white' : darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
                      >
                        â˜€ï¸ ãƒ©ã‚¤ãƒˆ
                      </button>
                      <button
                        onClick={() => setDarkMode(true)}
                        className={`flex-1 px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                      >
                        ğŸŒ™ ãƒ€ãƒ¼ã‚¯
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      ãƒ•ã‚©ãƒ³ãƒˆ
                    </label>
                    <select
                      value={fontFamily}
                      onChange={(e) => setFontFamily(e.target.value)}
                      className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-700'}`}
                    >
                      <optgroup label="ã‚´ã‚·ãƒƒã‚¯ç³»">
                        <option value="gothic">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="meiryo">ãƒ¡ã‚¤ãƒªã‚ª</option>
                        <option value="noto-sans">Noto Sans JP</option>
                      </optgroup>
                      <optgroup label="æ˜æœç³»">
                        <option value="mincho">æ¸¸æ˜æœ</option>
                        <option value="noto-serif">Noto Serif JP</option>
                      </optgroup>
                      <optgroup label="å¤‰ã‚ã‚Šç¨®">
                        <option value="maru">ä¸¸ã‚´ã‚·ãƒƒã‚¯ï¼ˆZen Maruï¼‰</option>
                        <option value="klee">æ‰‹æ›¸ãé¢¨ï¼ˆKlee Oneï¼‰</option>
                      </optgroup>
                    </select>
                  </div>
                </div>

                <button
                  onClick={() => setShowSettings(false)}
                  className="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  é–‰ã˜ã‚‹
                </button>
              </div>
            </div>
          )}

          {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <div className="flex-1 overflow-auto">
            {activeTab === 'ãƒ†ãƒ¼ãƒ' && (
              <ThemeTab project={currentProject} updateProject={updateCurrentProject} darkMode={darkMode} fontFamily={fontFamily} />
            )}
            {activeTab === 'ãƒ—ãƒ­ãƒƒãƒˆ' && (
              <PlotTab
                project={currentProject}
                updateProject={updateCurrentProject}
                draggedCard={draggedCard}
                setDraggedCard={setDraggedCard}
                darkMode={darkMode}
                fontFamily={fontFamily}
              />
            )}
            {activeTab === 'ç·¨é›†' && (
              <ManuscriptTab 
                project={currentProject} 
                updateProject={updateCurrentProject} 
                darkMode={darkMode} 
                fontFamily={fontFamily}
                immersiveMode={immersiveMode}
                setImmersiveMode={setImmersiveMode}
              />
            )}
            {activeTab === 'ç™»å ´äººç‰©' && (
              <CharacterTab project={currentProject} updateProject={updateCurrentProject} darkMode={darkMode} fontFamily={fontFamily} />
            )}
            {activeTab === 'ä¸–ç•Œè¦³' && (
              <WorldTab project={currentProject} updateProject={updateCurrentProject} darkMode={darkMode} fontFamily={fontFamily} />
            )}
          </div>
        </div>
      );
    }

    // ãƒ†ãƒ¼ãƒã‚¿ãƒ–
    function ThemeTab({ project, updateProject, darkMode, fontFamily }) {
      const [isEditing, setIsEditing] = useState(false);
      const textareaRef = useRef(null);
      const fontClass = getFontClass(fontFamily);

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹é–¢æ•°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒï¼‰
      const adjustTextareaHeight = () => {
        const textarea = textareaRef.current;
        if (textarea) {
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
          
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
          window.scrollTo(0, scrollTop);
        }
      };

      // åˆæœŸè¡¨ç¤ºæ™‚ã¨project.themeãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«é«˜ã•ã‚’èª¿æ•´
      useEffect(() => {
        if (isEditing) {
          adjustTextareaHeight();
        }
      }, [project.theme, isEditing]);

      return (
        <div className="p-8">
          {/* ç·¨é›†/ç¢ºèªãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */}
          <div className="flex justify-between items-center mb-6">
            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ãƒ†ãƒ¼ãƒè¨­å®š</h2>
            <button
              onClick={() => setIsEditing(!isEditing)}
              className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
            >
              {isEditing ? 'âœ“ ç¢ºèªãƒ¢ãƒ¼ãƒ‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰'}
            </button>
          </div>

          {isEditing ? (
            /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ */
            <div className="max-w-4xl mx-auto">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6 mb-6`}>
                <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  ä½œå“ã‚¿ã‚¤ãƒˆãƒ«
                </label>
                <input
                  type="text"
                  value={project.title}
                  onChange={(e) => updateProject({ title: e.target.value })}
                  className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  placeholder="ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
                />
              </div>

              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  ãƒ†ãƒ¼ãƒãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
                </label>
                <textarea
                  ref={textareaRef}
                  value={project.theme}
                  onChange={(e) => {
                    updateProject({ theme: e.target.value });
                    adjustTextareaHeight();
                  }}
                  className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none overflow-hidden ${fontClass} ${darkMode ? 'bg-gray-700 border-gray-600 text-comfortable-dark' : 'border-gray-300 text-comfortable-light'}`}
                  style={{ minHeight: '200px' }}
                  placeholder="ç‰©èªã®ãƒ†ãƒ¼ãƒã‚„ä¼ãˆãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„"
                />
              </div>
            </div>
          ) : (
            /* ç¢ºèªãƒ¢ãƒ¼ãƒ‰ */
            <div className="max-w-4xl mx-auto">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-8 space-y-6`}>
                <div>
                  <h3 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>
                    {project.title || 'æœªè¨­å®š'}
                  </h3>
                </div>

                {project.theme && (
                  <div>
                    <h3 className={`text-lg font-bold ${darkMode ? 'text-gray-300' : 'text-gray-800'} mb-3 pb-2 border-b ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                      â–  ãƒ†ãƒ¼ãƒãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
                    </h3>
                    <p className={`whitespace-pre-wrap leading-relaxed ${fontClass} ${darkMode ? 'text-comfortable-dark' : 'text-comfortable-light'}`}>
                      {project.theme}
                    </p>
                  </div>
                )}

                {!project.theme && (
                  <div className={`text-center py-12 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                    å³ä¸Šã®ã€Œâœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    // ãƒ—ãƒ­ãƒƒãƒˆã‚¿ãƒ–
    function PlotTab({ project, updateProject, draggedCard, setDraggedCard, darkMode, fontFamily }) {
      const sections = ['èµ·', 'æ‰¿', 'è»¢', 'çµ'];
      const [isEditing, setIsEditing] = useState(false);
      const [editingCard, setEditingCard] = useState(null); // { section, card }
      const [modalText, setModalText] = useState('');
      const fontClass = getFontClass(fontFamily);

      const openModal = (section, card) => {
        setEditingCard({ section, card });
        setModalText(card.text);
      };

      const closeModal = () => {
        setEditingCard(null);
        setModalText('');
      };

      const saveModal = () => {
        if (editingCard) {
          updateCard(editingCard.section, editingCard.card.id, modalText);
          closeModal();
        }
      };

      const addCard = (section) => {
        const newPlot = { ...project.plot };
        newPlot[section].push({
          id: Date.now(),
          text: ''
        });
        updateProject({ plot: newPlot });
      };

      const updateCard = (section, cardId, text) => {
        const newPlot = { ...project.plot };
        const cardIndex = newPlot[section].findIndex(c => c.id === cardId);
        if (cardIndex !== -1) {
          newPlot[section][cardIndex].text = text;
          updateProject({ plot: newPlot });
        }
      };

      const deleteCard = (section, cardId) => {
        const newPlot = { ...project.plot };
        newPlot[section] = newPlot[section].filter(c => c.id !== cardId);
        updateProject({ plot: newPlot });
      };

      const handleDragStart = (section, card) => {
        setDraggedCard({ section, card });
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (targetSection) => {
        if (!draggedCard) return;

        const newPlot = { ...project.plot };
        
        newPlot[draggedCard.section] = newPlot[draggedCard.section].filter(
          c => c.id !== draggedCard.card.id
        );
        
        newPlot[targetSection].push(draggedCard.card);
        
        updateProject({ plot: newPlot });
        setDraggedCard(null);
      };

      const exportPlotToTxt = () => {
        let content = `ã€${project.title} - ãƒ—ãƒ­ãƒƒãƒˆã€‘\n\n`;
        sections.forEach(section => {
          content += `â–  ${section}\n`;
          project.plot[section].forEach((card, index) => {
            content += `${index + 1}. ${card.text}\n`;
          });
          content += '\n';
        });
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${project.title}_ãƒ—ãƒ­ãƒƒãƒˆ.txt`;
        link.click();
      };

      const importPlotFromTxt = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const text = event.target.result;
            // ç°¡æ˜“çš„ãªãƒ‘ãƒ¼ã‚¹ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å˜ä½ã§åˆ†å‰²ï¼‰
            const newPlot = { èµ·: [], æ‰¿: [], è»¢: [], çµ: [] };
            let currentSection = null;
            
            text.split('\n').forEach(line => {
              const sectionMatch = line.match(/^â– \s*([èµ·æ‰¿è»¢çµ])/);
              if (sectionMatch) {
                currentSection = sectionMatch[1];
              } else if (currentSection && line.match(/^\d+\.\s+(.+)/)) {
                const content = line.replace(/^\d+\.\s+/, '');
                newPlot[currentSection].push({
                  id: Date.now() + Math.random(),
                  text: content
                });
              }
            });
            
            updateProject({ plot: newPlot });
          };
          reader.readAsText(file, 'UTF-8');
        }
      };

      return (
        <div className="p-8">
          <div className="flex justify-between items-center mb-6">
            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setIsEditing(!isEditing)}
                className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
              >
                {isEditing ? 'âœ“ ç¢ºèªãƒ¢ãƒ¼ãƒ‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰'}
              </button>
              <button
                onClick={exportPlotToTxt}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
              >
                ğŸ“„ TXTå‡ºåŠ›
              </button>
              <label className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm cursor-pointer">
                ğŸ“¥ TXTèª­è¾¼
                <input type="file" accept=".txt" onChange={importPlotFromTxt} className="hidden" />
              </label>
            </div>
          </div>

          {isEditing ? (
            /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ - ã‚«ãƒ¼ãƒ‰å½¢å¼ */
            <div className="grid grid-cols-4 gap-4">
              {sections.map((section) => (
                <div
                  key={section}
                  className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow`}
                  onDragOver={handleDragOver}
                  onDrop={() => handleDrop(section)}
                >
                  <div className={`p-4 border-b rounded-t-lg ${darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'}`}>
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>- {section} -</h3>
                  </div>

                  <div className="p-4 space-y-3 card-column">
                    {project.plot[section].map((card) => (
                      <div
                        key={card.id}
                        draggable
                        onDragStart={() => handleDragStart(section, card)}
                        onDoubleClick={() => openModal(section, card)}
                        className={`p-3 rounded-lg border cursor-move hover:shadow-md transition group relative ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}
                      >
                        <div className={`text-sm whitespace-pre-wrap ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {card.text || <span className="text-gray-400 italic">ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†...</span>}
                        </div>
                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              openModal(section, card);
                            }}
                            className="text-blue-500 hover:text-blue-700 transition text-xs"
                          >
                            âœï¸
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteCard(section, card.id);
                            }}
                            className="text-red-500 hover:text-red-700 transition text-xs"
                          >
                            âœ•
                          </button>
                        </div>
                      </div>
                    ))}
                    
                    <button
                      onClick={() => addCard(section)}
                      className={`w-full py-2 text-sm border border-dashed rounded-lg transition ${darkMode ? 'text-gray-400 hover:text-gray-300 border-gray-600 hover:border-gray-500' : 'text-gray-500 hover:text-gray-700 border-gray-300 hover:border-gray-400'}`}
                    >
                      + ã‚«ãƒ¼ãƒ‰è¿½åŠ 
                    </button>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            /* ç¢ºèªãƒ¢ãƒ¼ãƒ‰ - ãƒªã‚¹ãƒˆå½¢å¼ */
            <div className="max-w-4xl mx-auto">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-8 space-y-8`}>
                {sections.map((section) => (
                  <div key={section}>
                    <h3 className={`text-xl font-bold ${darkMode ? 'text-gray-300' : 'text-gray-800'} mb-4 pb-2 border-b ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                      â–  {section}
                    </h3>
                    {project.plot[section].length > 0 ? (
                      <div className="space-y-3">
                        {project.plot[section].map((card, index) => (
                          <div key={card.id} className={`pl-6 ${fontClass} ${darkMode ? 'text-comfortable-dark' : 'text-comfortable-light'}`}>
                            <span className={`font-bold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{index + 1}. </span>
                            <span className="whitespace-pre-wrap leading-relaxed">{card.text}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className={`pl-6 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                        ãƒ—ãƒ­ãƒƒãƒˆãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“
                      </div>
                    )}
                  </div>
                ))}

                {sections.every(section => project.plot[section].length === 0) && (
                  <div className={`text-center py-12 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                    å³ä¸Šã®ã€Œâœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ—ãƒ­ãƒƒãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                  </div>
                )}
              </div>
            </div>
          )}

          {/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */}
          {editingCard && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
              onClick={closeModal}
            >
              <div 
                className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-2xl w-full max-w-3xl mx-4`}
                onClick={(e) => e.stopPropagation()}
              >
                <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    ãƒ—ãƒ­ãƒƒãƒˆç·¨é›† - {editingCard.section}
                  </h3>
                </div>
                
                <div className="p-6">
                  <textarea
                    value={modalText}
                    onChange={(e) => setModalText(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Escape') closeModal();
                      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) saveModal();
                    }}
                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none ${darkMode ? 'bg-gray-700 border-gray-600 ${fontClass} text-comfortable-dark' : 'border-gray-300 ${fontClass} text-comfortable-light'}`}
                    rows="12"
                    placeholder="ãƒ—ãƒ­ãƒƒãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    autoFocus
                  />
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                    ãƒ’ãƒ³ãƒˆ: Ctrl+Enter ã§ä¿å­˜ / ESC ã§é–‰ã˜ã‚‹
                  </p>
                </div>
                
                <div className={`p-6 border-t flex justify-end gap-3 ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                  <button
                    onClick={closeModal}
                    className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={saveModal}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                  >
                    ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // åŸç¨¿ç·¨é›†ã‚¿ãƒ–
    function ManuscriptTab({ project, updateProject, darkMode, fontFamily, immersiveMode, setImmersiveMode }) {
      const [selectedChapter, setSelectedChapter] = useState(null);
      const [editingTitleId, setEditingTitleId] = useState(null);
      const [editingTitleText, setEditingTitleText] = useState('');
      const [fontSize, setFontSize] = useState(16);
      const [showSidebar, setShowSidebar] = useState(false);
      const [draggedChapter, setDraggedChapter] = useState(null);
      const textareaRef = useRef(null);
      const fontClass = getFontClass(fontFamily);

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹é–¢æ•°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒï¼‰
      const adjustTextareaHeight = () => {
        const textarea = textareaRef.current;
        if (textarea) {
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
          const scrollContainer = textarea.closest('.overflow-auto');
          const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
          
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
          
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
          if (scrollContainer) {
            scrollContainer.scrollTop = scrollTop;
          }
        }
      };

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç« ã‚’è‡ªå‹•é¸æŠ
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const chapterId = urlParams.get('chapter');
        
        if (chapterId && project.manuscripts) {
          const chapter = project.manuscripts.find(m => m.id === parseInt(chapterId));
          if (chapter) {
            setSelectedChapter(chapter);
          }
        }
      }, [project.manuscripts]);

      // åˆ¥ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚’åæ˜ ï¼ˆé¸æŠä¸­ã®ç« ã‚’åŒæœŸï¼‰
      useEffect(() => {
        if (selectedChapter && project.manuscripts) {
          const updated = project.manuscripts.find(m => m.id === selectedChapter.id);
          if (updated && JSON.stringify(updated) !== JSON.stringify(selectedChapter)) {
            setSelectedChapter(updated);
          }
        }
      }, [project.manuscripts]);

      // åˆ¥ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚’åæ˜ ï¼ˆé¸æŠä¸­ã®ç« ã‚’åŒæœŸï¼‰
      useEffect(() => {
        if (selectedChapter && project.manuscripts) {
          const updated = project.manuscripts.find(m => m.id === selectedChapter.id);
          if (updated && JSON.stringify(updated) !== JSON.stringify(selectedChapter)) {
            setSelectedChapter(updated);
          }
        }
      }, [project.manuscripts]);

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’åˆæœŸåŒ–ãƒ»æ›´æ–°æ™‚ã«èª¿æ•´
      useEffect(() => {
        if (selectedChapter && !immersiveMode) {
          adjustTextareaHeight();
        }
      }, [selectedChapter?.content, immersiveMode]);

      const addChapter = () => {
        const newManuscripts = [...project.manuscripts];
        newManuscripts.push({
          id: Date.now(),
          title: `ç¬¬${newManuscripts.length + 1}ç« `,
          content: ''
        });
        updateProject({ manuscripts: newManuscripts });
        setSelectedChapter(newManuscripts[newManuscripts.length - 1]);
      };

      const updateChapter = (chapterId, field, value) => {
        const newManuscripts = project.manuscripts.map(m =>
          m.id === chapterId ? { ...m, [field]: value } : m
        );
        updateProject({ manuscripts: newManuscripts });
        if (selectedChapter && selectedChapter.id === chapterId) {
          setSelectedChapter({ ...selectedChapter, [field]: value });
        }
      };

      const deleteChapter = (chapterId) => {
        const newManuscripts = project.manuscripts.filter(m => m.id !== chapterId);
        updateProject({ manuscripts: newManuscripts });
        if (selectedChapter && selectedChapter.id === chapterId) {
          setSelectedChapter(null);
        }
      };

      const startEditingTitle = (chapter) => {
        setEditingTitleId(chapter.id);
        setEditingTitleText(chapter.title);
      };

      const finishEditingTitle = () => {
        if (editingTitleId && editingTitleText.trim()) {
          updateChapter(editingTitleId, 'title', editingTitleText.trim());
        }
        setEditingTitleId(null);
        setEditingTitleText('');
      };

      const handleTitleKeyDown = (e) => {
        if (e.key === 'Enter') {
          finishEditingTitle();
        } else if (e.key === 'Escape') {
          setEditingTitleId(null);
          setEditingTitleText('');
        }
      };

      const handleDragStart = (chapter) => {
        setDraggedChapter(chapter);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (targetChapter) => {
        if (!draggedChapter || draggedChapter.id === targetChapter.id) return;

        const newManuscripts = [...project.manuscripts];
        const draggedIndex = newManuscripts.findIndex(c => c.id === draggedChapter.id);
        const targetIndex = newManuscripts.findIndex(c => c.id === targetChapter.id);

        newManuscripts.splice(draggedIndex, 1);
        const finalTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
        newManuscripts.splice(finalTargetIndex, 0, draggedChapter);

        updateProject({ manuscripts: newManuscripts });
        setDraggedChapter(null);
      };

      const getCharCount = (text) => {
        return text.replace(/\s/g, '').length;
      };

      const exportChapterToTxt = () => {
        if (!selectedChapter) return;
        const content = `${selectedChapter.title}\n\n${selectedChapter.content}`;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${selectedChapter.title}.txt`;
        link.click();
      };

      const exportAllToTxt = () => {
        let content = `${project.title}\n\n`;
        project.manuscripts.forEach(chapter => {
          content += `\n\n${'='.repeat(50)}\n`;
          content += `${chapter.title}\n`;
          content += `${'='.repeat(50)}\n\n`;
          content += chapter.content;
        });
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${project.title}_å…¨åŸç¨¿.txt`;
        link.click();
      };

      const importChapterFromTxt = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const text = event.target.result;
            const title = file.name.replace('.txt', '');
            const content = text.trim();
            
            const newManuscripts = [...project.manuscripts];
            newManuscripts.push({
              id: Date.now(),
              title: title,
              content: content
            });
            updateProject({ manuscripts: newManuscripts });
            setSelectedChapter(newManuscripts[newManuscripts.length - 1]);
          };
          reader.readAsText(file, 'UTF-8');
        }
      };

      if (immersiveMode && selectedChapter) {
        return (
          <div className={`immersive-editor ${darkMode ? 'dark' : ''} relative ${fontClass}`}>
            {/* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */}
            <button
              onClick={() => setShowSidebar(!showSidebar)}
              className={`fixed top-4 left-4 z-50 p-3 rounded-lg ${darkMode ? 'bg-gray-800 text-white hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'} shadow-lg`}
            >
              â˜°
            </button>

            {/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³åŸç¨¿ä¸€è¦§ */}
            {showSidebar && (
              <>
                {/* èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
                <div
                  className="fixed inset-0 bg-black bg-opacity-30 z-40"
                  onClick={() => setShowSidebar(false)}
                />
                
                {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
                <div className={`fixed left-0 top-0 h-full w-64 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-r p-4 z-50 shadow-2xl`}>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>åŸç¨¿ä¸€è¦§</h3>
                    <button
                      onClick={addChapter}
                      className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} text-xl`}
                    >
                      +
                    </button>
                  </div>
                  
                  <div className="space-y-2 mb-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                    {project.manuscripts.map((chapter) => (
                      <div
                        key={chapter.id}
                        draggable
                        onDragStart={() => handleDragStart(chapter)}
                        onDragOver={handleDragOver}
                        onDrop={() => handleDrop(chapter)}
                        className={`p-3 rounded-lg cursor-move transition group relative ${
                          selectedChapter?.id === chapter.id
                            ? darkMode ? 'bg-blue-900 border border-blue-700' : 'bg-blue-50 border border-blue-200'
                            : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                        }`}
                      >
                        {editingTitleId === chapter.id ? (
                          <input
                            type="text"
                            value={editingTitleText}
                            onChange={(e) => setEditingTitleText(e.target.value)}
                            onBlur={finishEditingTitle}
                            onKeyDown={handleTitleKeyDown}
                            className={`w-full text-sm font-medium px-2 py-1 rounded ${darkMode ? 'bg-gray-600 text-white' : 'bg-white text-gray-800'} border-2 border-blue-500`}
                            autoFocus
                            onClick={(e) => e.stopPropagation()}
                          />
                        ) : (
                          <div
                            onClick={() => {
                              setSelectedChapter(chapter);
                              setShowSidebar(false); // é¸æŠã—ãŸã‚‰é–‰ã˜ã‚‹
                            }}
                            onDoubleClick={() => startEditingTitle(chapter)}
                            className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}
                          >
                            {chapter.title}
                          </div>
                        )}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteChapter(chapter.id);
                          }}
                          className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 text-xs"
                        >
                          å‰Šé™¤
                        </button>
                      </div>
                    ))}
                  </div>

                  <div className="space-y-2 pt-4 border-t border-gray-600">
                    <button
                      onClick={exportAllToTxt}
                      className="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                    >
                      ğŸ“„ å…¨åŸç¨¿TXTå‡ºåŠ›
                    </button>
                    <label className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm block text-center cursor-pointer">
                      ğŸ“¥ TXTèª­è¾¼
                      <input type="file" accept=".txt" onChange={importChapterFromTxt} className="hidden" />
                    </label>
                  </div>
                </div>
              </>
            )}

            <div className="writing-area" style={{ maxWidth: '900px' }}>
              <textarea
                value={selectedChapter.content}
                onChange={(e) => updateChapter(selectedChapter.id, 'content', e.target.value)}
                className={`flex-1 w-full bg-transparent border-none focus:outline-none resize-none ${fontClass} ${darkMode ? 'text-comfortable-dark' : 'text-comfortable-light'}`}
                style={{ fontSize: `${fontSize}px` }}
                placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."
              />
              
              <div className={`flex justify-between items-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} flex-shrink-0`}>
                <div className="flex gap-2 items-center">
                  <button
                    onClick={() => setFontSize(Math.max(12, fontSize - 2))}
                    className={`px-2 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                  >
                    A-
                  </button>
                  <span className="text-xs">{fontSize}px</span>
                  <button
                    onClick={() => setFontSize(Math.min(32, fontSize + 2))}
                    className={`px-2 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                  >
                    A+
                  </button>
                </div>
                
                <div className="flex gap-4 items-center">
                  <button
                    onClick={() => setImmersiveMode(false)}
                    className={`px-3 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                  >
                    â† é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                  </button>
                  <button
                    onClick={exportChapterToTxt}
                    className={`px-3 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                  >
                    ğŸ“„ TXTå‡ºåŠ›
                  </button>
                  <span>{getCharCount(selectedChapter.content)}å­—</span>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="flex h-full">
          {/* ç« ãƒªã‚¹ãƒˆ */}
          <div className={`w-64 border-r p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>åŸç¨¿ä¸€è¦§</h3>
              <button
                onClick={addChapter}
                className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} text-xl`}
              >
                +
              </button>
            </div>
            
            <div className="space-y-2 mb-4">
              {project.manuscripts.map((chapter) => (
                <div
                  key={chapter.id}
                  draggable
                  onDragStart={() => handleDragStart(chapter)}
                  onDragOver={handleDragOver}
                  onDrop={() => handleDrop(chapter)}
                  className={`p-3 rounded-lg cursor-move transition group relative ${
                    selectedChapter?.id === chapter.id
                      ? darkMode ? 'bg-blue-900 border border-blue-700' : 'bg-blue-50 border border-blue-200'
                      : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  {editingTitleId === chapter.id ? (
                    <input
                      type="text"
                      value={editingTitleText}
                      onChange={(e) => setEditingTitleText(e.target.value)}
                      onBlur={finishEditingTitle}
                      onKeyDown={handleTitleKeyDown}
                      className={`w-full text-sm font-medium px-2 py-1 rounded ${darkMode ? 'bg-gray-600 text-white' : 'bg-white text-gray-800'} border-2 border-blue-500`}
                      autoFocus
                      onClick={(e) => e.stopPropagation()}
                    />
                  ) : (
                    <div
                      onClick={() => setSelectedChapter(chapter)}
                      onDoubleClick={() => startEditingTitle(chapter)}
                      className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}
                    >
                      {chapter.title}
                    </div>
                  )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteChapter(chapter.id);
                    }}
                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 text-xs"
                  >
                    å‰Šé™¤
                  </button>
                </div>
              ))}
            </div>

            <div className="space-y-2 pt-4 border-t border-gray-600">
              <button
                onClick={exportAllToTxt}
                className="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
              >
                ğŸ“„ å…¨åŸç¨¿TXTå‡ºåŠ›
              </button>
              <label className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm block text-center cursor-pointer">
                ğŸ“¥ TXTèª­è¾¼
                <input type="file" accept=".txt" onChange={importChapterFromTxt} className="hidden" />
              </label>
            </div>
          </div>

          {/* ã‚¨ãƒ‡ã‚£ã‚¿ */}
          <div className="flex-1 flex flex-col">
            {selectedChapter ? (
              <>
                {/* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className={`px-8 py-4 border-b flex-shrink-0 ${darkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                  <div className={`max-w-4xl mx-auto flex justify-between items-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    <div className="flex gap-2 items-center">
                      <button
                        onClick={() => setFontSize(Math.max(12, fontSize - 2))}
                        className={`px-2 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                      >
                        A-
                      </button>
                      <span className="text-xs">{fontSize}px</span>
                      <button
                        onClick={() => setFontSize(Math.min(32, fontSize + 2))}
                        className={`px-2 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                      >
                        A+
                      </button>
                    </div>
                    
                    <div className="flex gap-4 items-center">
                      <button
                        onClick={() => setImmersiveMode(true)}
                        className={`px-3 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                      >
                        ğŸ¯ æ²¡å…¥ãƒ¢ãƒ¼ãƒ‰
                      </button>
                      <button
                        onClick={() => {
                          const url = window.location.href + '?immersive=true&chapter=' + selectedChapter.id;
                          window.open(url, '_blank');
                        }}
                        className={`px-3 py-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                      >
                        ğŸªŸ æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                      </button>
                      <span className="font-medium">{getCharCount(selectedChapter.content)}å­—</span>
                    </div>
                  </div>
                </div>

                {/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */}
                <div className="flex-1 overflow-auto p-8">
                  <div className="max-w-4xl mx-auto">
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                      <textarea
                        ref={textareaRef}
                        value={selectedChapter.content}
                        onChange={(e) => {
                          updateChapter(selectedChapter.id, 'content', e.target.value);
                          adjustTextareaHeight();
                        }}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none overflow-hidden ${darkMode ? 'bg-gray-700 border-gray-600 ${fontClass} text-comfortable-dark' : 'border-gray-300 ${fontClass} text-comfortable-light'}`}
                        style={{ fontSize: `${fontSize}px`, minHeight: '300px' }}
                        placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."
                      />
                    </div>
                  </div>
                </div>
              </>
            ) : (
              <div className={`flex items-center justify-center h-full ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                å·¦ã‹ã‚‰ç« ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„
              </div>
            )}
          </div>
        </div>
      );
    }

    // ç™»å ´äººç‰©ã‚¿ãƒ–
    function CharacterTab({ project, updateProject, darkMode, fontFamily }) {
      const [selectedCharacter, setSelectedCharacter] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [draggedCharacter, setDraggedCharacter] = useState(null);
      const fontClass = getFontClass(fontFamily);

      const addCharacter = () => {
        const newCharacters = [...project.characters];
        const newChar = {
          id: Date.now(),
          name: '',
          role: '',
          status: '',
          overview: '',
          speechStyle: ''
        };
        newCharacters.push(newChar);
        updateProject({ characters: newCharacters });
        setSelectedCharacter(newChar);
        setIsEditing(true);
      };

      const updateCharacter = (field, value) => {
        const updated = { ...selectedCharacter, [field]: value };
        setSelectedCharacter(updated);
        const newCharacters = project.characters.map(c =>
          c.id === updated.id ? updated : c
        );
        updateProject({ characters: newCharacters });
      };

      const deleteCharacter = (charId) => {
        const newCharacters = project.characters.filter(c => c.id !== charId);
        updateProject({ characters: newCharacters });
        if (selectedCharacter?.id === charId) {
          setSelectedCharacter(null);
          setIsEditing(false);
        }
      };

      const handleDragStart = (character) => {
        setDraggedCharacter(character);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (targetCharacter) => {
        if (!draggedCharacter || draggedCharacter.id === targetCharacter.id) return;

        const newCharacters = [...project.characters];
        const draggedIndex = newCharacters.findIndex(c => c.id === draggedCharacter.id);
        const targetIndex = newCharacters.findIndex(c => c.id === targetCharacter.id);

        newCharacters.splice(draggedIndex, 1);
        const finalTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
        newCharacters.splice(finalTargetIndex, 0, draggedCharacter);

        updateProject({ characters: newCharacters });
        setDraggedCharacter(null);
      };

      const exportCharactersToTxt = () => {
        let content = `ã€${project.title} - ç™»å ´äººç‰©è¨­å®šã€‘\n\n`;
        project.characters.forEach(char => {
          content += `${'='.repeat(50)}\n`;
          content += `â–  ${char.name || 'æœªè¨­å®š'} ï¼ˆ${char.role || 'å½¹å‰²ãªã—'}ï¼‰\n`;
          content += `${'='.repeat(50)}\n\n`;
          if (char.status) content += `èº«åˆ†ãƒ»å±æ€§: ${char.status}\n\n`;
          if (char.overview) content += `ã€æ¦‚è¦ã€‘\n${char.overview}\n\n`;
          if (char.speechStyle) content += `ã€å£èª¿ä¾‹ã€‘\n${char.speechStyle}\n\n`;
          content += '\n';
        });
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${project.title}_ç™»å ´äººç‰©.txt`;
        link.click();
      };

      return (
        <div className="flex h-full">
          {/* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ */}
          <div className={`w-80 border-r p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ç™»å ´äººç‰©ä¸€è¦§</h3>
              <button
                onClick={addCharacter}
                className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
              >
                + æ–°ã—ãç™»éŒ²ã™ã‚‹
              </button>
            </div>
            
            <div className="space-y-2 mb-4">
              {project.characters.map((character) => (
                <div
                  key={character.id}
                  draggable
                  onDragStart={() => handleDragStart(character)}
                  onDragOver={handleDragOver}
                  onDrop={() => handleDrop(character)}
                  onClick={() => {
                    setSelectedCharacter(character);
                    setIsEditing(false);
                  }}
                  className={`p-3 rounded-lg cursor-move transition group relative ${
                    selectedCharacter?.id === character.id
                      ? darkMode ? 'bg-blue-900 border border-blue-700' : 'bg-blue-50 border border-blue-200'
                      : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {character.name || 'æœªè¨­å®š'}
                  </div>
                  {character.role && (
                    <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      {character.role}
                    </div>
                  )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteCharacter(character.id);
                    }}
                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 text-xs"
                  >
                    å‰Šé™¤
                  </button>
                </div>
              ))}
            </div>

            <button
              onClick={exportCharactersToTxt}
              className="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
            >
              ğŸ“„ TXTå‡ºåŠ›
            </button>
          </div>

          {/* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´° */}
          <div className="flex-1 p-8 overflow-auto">
            {selectedCharacter ? (
              <div className="max-w-4xl mx-auto">
                {/* ç·¨é›†/ç¢ºèªãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */}
                <div className="flex justify-end mb-4">
                  <button
                    onClick={() => setIsEditing(!isEditing)}
                    className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                  >
                    {isEditing ? 'âœ“ ç¢ºèªãƒ¢ãƒ¼ãƒ‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰'}
                  </button>
                </div>

                {isEditing ? (
                  /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ */
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6 space-y-4`}>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          åå‰ <span className="text-red-500">*</span>
                        </label>
                        <input
                          type="text"
                          value={selectedCharacter.name}
                          onChange={(e) => updateCharacter('name', e.target.value)}
                          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          å½¹å‰²
                        </label>
                        <input
                          type="text"
                          value={selectedCharacter.role}
                          onChange={(e) => updateCharacter('role', e.target.value)}
                          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          placeholder="ä¾‹: ä¸»äººå…¬ã€ãƒ’ãƒ­ã‚¤ãƒ³"
                        />
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        èº«åˆ†ãƒ»å±æ€§
                      </label>
                      <input
                        type="text"
                        value={selectedCharacter.status}
                        onChange={(e) => updateCharacter('status', e.target.value)}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        placeholder="ä¾‹: ç‹æ—ã€é­”æ³•ä½¿ã„ã€å­¦ç”Ÿ"
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        æ¦‚è¦
                      </label>
                      <textarea
                        value={selectedCharacter.overview}
                        onChange={(e) => updateCharacter('overview', e.target.value)}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none ${darkMode ? 'bg-gray-700 border-gray-600 ${fontClass} text-comfortable-dark' : 'border-gray-300 ${fontClass} text-comfortable-light'}`}
                        rows="8"
                        placeholder="æ€§æ ¼ã€ç‰¹å¾´ã€èƒŒæ™¯ã€èƒ½åŠ›ãªã©ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ¦‚è¦ã‚’è¨˜è¿°..."
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        å£èª¿ä¾‹
                      </label>
                      <textarea
                        value={selectedCharacter.speechStyle}
                        onChange={(e) => updateCharacter('speechStyle', e.target.value)}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none ${darkMode ? 'bg-gray-700 border-gray-600 ${fontClass} text-comfortable-dark' : 'border-gray-300 ${fontClass} text-comfortable-light'}`}
                        rows="6"
                        placeholder="ã€Œã€œã ãœã€ã€Œã€œã§ã™ã‚ã€ãªã©ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å£èª¿ã‚„è©±ã—æ–¹ã®ä¾‹..."
                      />
                    </div>
                  </div>
                ) : (
                  /* ç¢ºèªãƒ¢ãƒ¼ãƒ‰ */
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-8 space-y-6`}>
                    <div>
                      <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2`}>
                        {selectedCharacter.name || 'æœªè¨­å®š'}
                      </h2>
                      {selectedCharacter.role && (
                        <p className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          {selectedCharacter.role}
                        </p>
                      )}
                    </div>

                    {selectedCharacter.status && (
                      <div>
                        <h3 className={`text-sm font-bold ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                          èº«åˆ†ãƒ»å±æ€§
                        </h3>
                        <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          {selectedCharacter.status}
                        </p>
                      </div>
                    )}

                    {selectedCharacter.overview && (
                      <div>
                        <h3 className={`text-lg font-bold ${darkMode ? 'text-gray-300' : 'text-gray-800'} mb-3 pb-2 border-b ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                          â–  æ¦‚è¦
                        </h3>
                        <p className={`whitespace-pre-wrap leading-relaxed ${fontClass} ${darkMode ? 'text-comfortable-dark' : 'text-comfortable-light'}`}>
                          {selectedCharacter.overview}
                        </p>
                      </div>
                    )}

                    {selectedCharacter.speechStyle && (
                      <div>
                        <h3 className={`text-lg font-bold ${darkMode ? 'text-gray-300' : 'text-gray-800'} mb-3 pb-2 border-b ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                          â–  å£èª¿ä¾‹
                        </h3>
                        <p className={`whitespace-pre-wrap leading-relaxed ${fontClass} ${darkMode ? 'text-comfortable-dark' : 'text-comfortable-light'}`}>
                          {selectedCharacter.speechStyle}
                        </p>
                      </div>
                    )}

                    {!selectedCharacter.overview && !selectedCharacter.speechStyle && !selectedCharacter.status && (
                      <div className={`text-center py-12 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                        å³ä¸Šã®ã€Œâœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                      </div>
                    )}
                  </div>
                )}
              </div>
            ) : (
              <div className={`flex items-center justify-center h-full ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                å·¦ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„
              </div>
            )}
          </div>
        </div>
      );
    }

    // ä¸–ç•Œè¦³ã‚¿ãƒ–
    function WorldTab({ project, updateProject, darkMode, fontFamily }) {
      const [selectedSetting, setSelectedSetting] = useState(null);
      const [editingTitleId, setEditingTitleId] = useState(null);
      const [editingTitleText, setEditingTitleText] = useState('');
      const [draggedSetting, setDraggedSetting] = useState(null);
      const fontClass = getFontClass(fontFamily);

      const addSetting = () => {
        const newSettings = [...project.worldSettings];
        const newSetting = {
          id: Date.now(),
          title: 'æœªè¨­å®š',
          content: ''
        };
        newSettings.push(newSetting);
        updateProject({ worldSettings: newSettings });
        setSelectedSetting(newSetting);
      };

      const updateSetting = (settingId, field, value) => {
        const newSettings = project.worldSettings.map(s =>
          s.id === settingId ? { ...s, [field]: value } : s
        );
        updateProject({ worldSettings: newSettings });
        if (selectedSetting && selectedSetting.id === settingId) {
          setSelectedSetting({ ...selectedSetting, [field]: value });
        }
      };

      const deleteSetting = (settingId) => {
        const newSettings = project.worldSettings.filter(s => s.id !== settingId);
        updateProject({ worldSettings: newSettings });
        if (selectedSetting?.id === settingId) {
          setSelectedSetting(null);
        }
      };

      const startEditingTitle = (setting) => {
        setEditingTitleId(setting.id);
        setEditingTitleText(setting.title);
      };

      const finishEditingTitle = () => {
        if (editingTitleId && editingTitleText.trim()) {
          updateSetting(editingTitleId, 'title', editingTitleText.trim());
        }
        setEditingTitleId(null);
        setEditingTitleText('');
      };

      const handleTitleKeyDown = (e) => {
        if (e.key === 'Enter') {
          finishEditingTitle();
        } else if (e.key === 'Escape') {
          setEditingTitleId(null);
          setEditingTitleText('');
        }
      };

      const handleDragStart = (setting) => {
        setDraggedSetting(setting);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (targetSetting) => {
        if (!draggedSetting || draggedSetting.id === targetSetting.id) return;

        const newSettings = [...project.worldSettings];
        const draggedIndex = newSettings.findIndex(s => s.id === draggedSetting.id);
        const targetIndex = newSettings.findIndex(s => s.id === targetSetting.id);

        // é…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦æŒ¿å…¥
        newSettings.splice(draggedIndex, 1);
        const finalTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
        newSettings.splice(finalTargetIndex, 0, draggedSetting);

        updateProject({ worldSettings: newSettings });
        setDraggedSetting(null);
      };

      const exportWorldToTxt = () => {
        let content = `ã€${project.title} - ä¸–ç•Œè¦³è¨­å®šã€‘\n\n`;
        project.worldSettings.forEach(setting => {
          content += `${'='.repeat(50)}\n`;
          content += `â–  ${setting.title || 'æœªè¨­å®š'}\n`;
          content += `${'='.repeat(50)}\n\n`;
          content += setting.content || '';
          content += '\n\n';
        });
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${project.title}_ä¸–ç•Œè¦³.txt`;
        link.click();
      };

      return (
        <div className="flex h-full">
          {/* è¨­å®šãƒªã‚¹ãƒˆ */}
          <div className={`w-64 border-r p-4 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ä¸–ç•Œè¦³è¨­å®š</h3>
              <button
                onClick={addSetting}
                className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} text-xl`}
              >
                +
              </button>
            </div>
            
            <div className="space-y-2 mb-4">
              {project.worldSettings.map((setting) => (
                <div
                  key={setting.id}
                  draggable
                  onDragStart={() => handleDragStart(setting)}
                  onDragOver={handleDragOver}
                  onDrop={() => handleDrop(setting)}
                  className={`p-3 rounded-lg cursor-move transition group relative ${
                    selectedSetting?.id === setting.id
                      ? darkMode ? 'bg-blue-900 border border-blue-700' : 'bg-blue-50 border border-blue-200'
                      : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  {editingTitleId === setting.id ? (
                    <input
                      type="text"
                      value={editingTitleText}
                      onChange={(e) => setEditingTitleText(e.target.value)}
                      onBlur={finishEditingTitle}
                      onKeyDown={handleTitleKeyDown}
                      className={`w-full text-sm font-medium px-2 py-1 rounded ${darkMode ? 'bg-gray-600 text-white' : 'bg-white text-gray-800'} border-2 border-blue-500`}
                      autoFocus
                      onClick={(e) => e.stopPropagation()}
                    />
                  ) : (
                    <div
                      onClick={() => setSelectedSetting(setting)}
                      onDoubleClick={() => startEditingTitle(setting)}
                      className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}
                    >
                      {setting.title}
                    </div>
                  )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteSetting(setting.id);
                    }}
                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 text-xs"
                  >
                    å‰Šé™¤
                  </button>
                </div>
              ))}
            </div>

            <button
              onClick={exportWorldToTxt}
              className="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
            >
              ğŸ“„ TXTå‡ºåŠ›
            </button>
          </div>

          {/* ã‚¨ãƒ‡ã‚£ã‚¿ */}
          <div className="flex-1 p-8 overflow-auto">
            {selectedSetting ? (
              <div className="max-w-4xl mx-auto h-full flex flex-col">
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6 flex-1 flex flex-col`}>
                  <textarea
                    value={selectedSetting.content || ''}
                    onChange={(e) => updateSetting(selectedSetting.id, 'content', e.target.value)}
                    className={`flex-1 w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none ${darkMode ? 'bg-gray-700 border-gray-600 ${fontClass} text-comfortable-dark' : 'border-gray-300 ${fontClass} text-comfortable-light'}`}
                    placeholder="è¨­å®šå†…å®¹ã‚’å…¥åŠ›..."
                  />
                </div>
              </div>
            ) : (
              <div className={`flex items-center justify-center h-full ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                å·¦ã‹ã‚‰è¨­å®šã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
